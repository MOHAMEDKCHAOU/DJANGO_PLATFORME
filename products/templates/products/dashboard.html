{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h2 class="mb-4">Dashboard Stock Manager</h2>

<!-- üî¥ Alertes stock faible -->
{% if low_stock_count > 0 %}
<div class="alert alert-danger">
    ‚ö†Ô∏è {{ low_stock_count }} produit(s) ont un stock faible :
    <ul>
        {% for p in low_stock_products %}
        <li>{{ p.name }} ({{ p.quantity }} restant)</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- üìä Cards statistiques -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3 shadow-sm">
            <div class="card-body text-center">
                <h6 class="card-title">Total Produits</h6>
                <p class="card-text fs-3">{{ total_products }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-warning mb-3 shadow-sm">
            <div class="card-body text-center">
                <h6 class="card-title">Stock Faible</h6>
                <p class="card-text fs-3">{{ low_stock_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3 shadow-sm">
            <div class="card-body text-center">
                <h6 class="card-title">Valeur totale stock</h6>
                <p class="card-text fs-3">{{ total_stock_value }} DT</p>
            </div>
        </div>
    </div>
</div>

<hr>

<!-- üìä Graphiques Chart.js -->
<div class="row">
    <div class="col-md-6 mb-4">
        <h6 class="mb-2">Produits par cat√©gorie</h6>
        <canvas id="categoryChart" height="250"></canvas>
    </div>
    <div class="col-md-6 mb-4">
        <h6 class="mb-2">Produits les plus vendus</h6>
        <canvas id="topSellingChart" height="250"></canvas>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
        <h6 class="mb-2">Historique entr√©es/sorties par mois</h6>
        <canvas id="monthlyChart" height="150"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* --- Graphique Cat√©gories --- */
const ctxCategory = document.getElementById('categoryChart').getContext('2d');
new Chart(ctxCategory, {
    type: 'doughnut',
    data: {
        labels: [{% for c in categories %}'{{ c.category }}',{% endfor %}],
        datasets: [{
            data: [{% for c in categories %}{{ c.total_qty }},{% endfor %}],
            backgroundColor: ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#17a2b8'],
            borderColor: '#fff',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.raw + ' produits'; } } }
        }
    }
});

/* --- Graphique Top Produits vendus --- */
const ctxTop = document.getElementById('topSellingChart').getContext('2d');
new Chart(ctxTop, {
    type: 'bar',
    data: {
        labels: [{% for p in top_selling %}'{{ p.product__name }}',{% endfor %}],
        datasets: [{
            label: 'Quantit√© vendue',
            data: [{% for p in top_selling %}{{ p.total_sold }},{% endfor %}],
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: { y: { beginAtZero: true } }
    }
});

/* --- Graphique historique mensuel --- */
const months = [];
const inData = [];
const outData = [];
{% for m in monthly_movements %}
months.push('{{ m.month|date:"M" }}');
if ('{{ m.movement_type }}' == 'IN') { inData.push({{ m.total }}); outData.push(0); } 
else { outData.push({{ m.total }}); inData.push(0); }
{% endfor %}

const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
new Chart(ctxMonthly, {
    type: 'line',
    data: {
        labels: months,
        datasets: [
            { label: 'Entr√©es', data: inData, borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.2)', fill: true, tension: 0.4 },
            { label: 'Sorties', data: outData, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.2)', fill: true, tension: 0.4 }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { y: { beginAtZero: true } }
    }
});
</script>

<hr>

<!-- üìã Produits critiques -->
<h6>Produits critiques</h6>
<table class="table table-sm table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>Nom</th><th>Quantit√©</th><th>Cat√©gorie</th><th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for p in low_stock_products %}
        <tr>
            <td>{{ p.name }}</td>
            <td>{{ p.quantity }}</td>
            <td>{{ p.category }}</td>
            <td>
                <a href="{% url 'product_edit' p.pk %}" class="btn btn-sm btn-success">R√©approvisionner</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
